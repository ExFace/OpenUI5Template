/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/Utils","sap/ui/rta/appVariant/AppVariantUtils","sap/ui/core/BusyIndicator","sap/ui/thirdparty/jquery","sap/base/util/UriParameters"],function(F,A,B,q,U){"use strict";var a,o,r,c,C,d,D,_;var g=function(){return F.getAppDescriptor(r);};var t=function(k){return o.createDescriptor(k).then(function(l){if(l){d=null;d=q.extend({},l);return d;}return Promise.reject();});};var T=function(k){return A.createDeletion(k).then(function(l){if(l){D=null;D=q.extend({},l);return D;}return Promise.reject();});};var f=function(k){B.show();return o.saveAppVariantToLREP(k);};var s=function(k){var m=k?"MSG_DO_NOT_CLOSE_BROWSER_CURRENTLY_ADAPTING":"MSG_DO_NOT_CLOSE_BROWSER";_=window.onbeforeunload;window.onbeforeunload=A.handleBeforeUnloadEvent;return A.showMessage(m);};var S=function(){window.onbeforeunload=_;};var b=function(){return o.triggerCatalogPublishing(d,true);};var e=function(){return o.triggerCatalogPublishing(D,false);};var R=function(I){if(a){A.closeOverviewDialog();return this.onGetOverview(true);}else if(!a&&I){B.hide();return this.onGetOverview(true);}return Promise.resolve();};var h=function(k,I){return k?A.navigateToFLPHomepage():R.call(this,!I);};var i=function(k,l){if(k&&k.response&&k.response.IAMId){return o.notifyKeyUserWhenPublishingIsReady(k.response.IAMId,l,true);}return Promise.resolve();};var j=function(k,l){if(k&&k.response&&k.response.IAMId&&k.response.inProgress){return o.notifyKeyUserWhenPublishingIsReady(k.response.IAMId,l,false);}return Promise.resolve();};sap.ui.getCore().getEventBus().subscribe("sap.ui.rta.appVariant.manageApps.controller.ManageApps","navigate",function(){if(a){a.destroy();a=null;}});return{onGetOverview:function(k){var l=g();return new Promise(function(m){var n=function(){A.closeOverviewDialog();};sap.ui.require(["sap/ui/rta/appVariant/AppVariantOverviewDialog"],function(p){if(!a){a=new p({idRunningApp:l["sap.app"].id,isOverviewForKeyUser:k});}a.attachCancel(n);a.oPopup.attachOpened(function(){m(a);});a.open();});});},isOverviewExtended:function(){var u=new U(window.location.href);if(!u.get("sap-ui-xx-app-variant-overview-extended")){return false;}var m=u.get("sap-ui-xx-app-variant-overview-extended",true);if(m&&m.length){var M=m[0].toLowerCase();return M==='true';}},isManifestSupported:function(){var k=g();return A.getManifirstSupport(k["sap.app"].id).then(function(l){return l.response;}).catch(function(E){var l=A.buildErrorInfo("MSG_APP_VARIANT_FEATURE_FAILED",E);l.overviewDialog=true;return A.showRelevantDialog(l,false);});},isPlatFormEnabled:function(k,l,L){r=k;c=L;var m=g();if(m["sap.app"]&&m["sap.app"].id){if(F.getUshellContainer()&&!A.isStandAloneApp()&&l==="CUSTOMER"){var I;if(m["sap.app"].crossNavigation&&m["sap.app"].crossNavigation.inbounds){I=A.getInboundInfo(m["sap.app"].crossNavigation.inbounds);}else{I=A.getInboundInfo();}if(I){return true;}}}return false;},getAppVariantDescriptor:function(k){r=k;var l=g();if(l["sap.app"]&&l["sap.app"].id){return A.getDescriptorFromLREP(l["sap.app"].id);}return Promise.resolve(false);},onSaveAsFromRtaToolbar:function(k,l){var m,I;if(k){m=g();}else{m=q.extend(true,{},C);C=null;}return new Promise(function(n){var p=function(){return o.processSaveAsDialog(m,k);};var u=function(){if(l){return o.copyUnsavedChangesToLREP(d.getId(),l);}return Promise.resolve();};var v=function(){var z=F.getUshellContainer();if(z&&l){z.setDirtyFlag(false);}};var w=function(){v();var z=A.buildSuccessInfo(d,k);return o.showSuccessMessage(z);};var x=function(){var z=A.buildFinalSuccessInfoS4HANACloud();return o.showSuccessMessage(z);};var y=function(){B.show();I=A.isS4HanaCloud(d.getSettings());if(I){return b().then(function(z){B.hide();return h.call(this,k).then(function(){k=false;return i(z,d.getId()).then(x);});}.bind(this));}return Promise.resolve();};sap.ui.require(["sap/ui/rta/appVariant/AppVariantManager"],function(z){if(!o){o=new z({rootControl:r,commandSerializer:c});}return p().then(t).then(f).then(u).then(w).then(y.bind(this)).finally(function(){return h.call(this,k,I).then(n);}.bind(this));}.bind(this));}.bind(this));},onSaveAsFromOverviewDialog:function(k,l){var m=false;var n=g();if(k["sap.app"].id===n["sap.app"].id){m=true;}C=q.extend(true,{},k);k=null;return this.onSaveAsFromRtaToolbar(l,m);},onDeleteFromOverviewDialog:function(k,l){var I;return new Promise(function(m){sap.ui.require(["sap/ui/rta/appVariant/AppVariantManager"],function(n){if(!o){o=new n({rootControl:r,commandSerializer:c});}var p=function(){return A.triggerDeleteAppVariantFromLREP(D);};var u=function(){I=A.isS4HanaCloud(D.getSettings());if(I){return s(l).then(e).then(function(w){return R.call(this).then(function(){return j(w,D.getId());});}.bind(this));}B.show();return Promise.resolve();};var v=function(){if(I){S();}B.hide();return R.call(this).then(m);};if(l){A.closeOverviewDialog();A.navigateToFLPHomepage();}return T(k).then(u.bind(this)).then(p).finally(v.bind(this));}.bind(this));}.bind(this));}};});
